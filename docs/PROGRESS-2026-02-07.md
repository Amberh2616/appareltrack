# 2026-02-07 STYLE-CENTER Stage 3 — 全流程串接重構

## 背景

使用者的核心任務：**上傳 Tech Pack PDF → 拿到 MWO PDF**

目前要 9 次操作、跨 4+ 個頁面、12 個 Kanban 狀態。
Style Center 原本只是唯讀儀表板，所有操作都要跳頁。
上傳的 PDF 可能歸到錯的 Style。多輪 Fit Sample 操作入口不明。

**目標：Style Center 變成真正的操作中心，一頁完成 80% 的事。**

---

## Stage 進度總覽

| Stage | 內容 | 狀態 |
|-------|------|------|
| 1 | 後端 Readiness API + Batch Verify API | ✅ 已完成 (02/03) |
| 2 | 前端款式列表頁 + Sidebar + API hooks | ✅ 已完成 (02/03) |
| **3 Part 1** | Style Center 重寫 (Tabs → Stepper) | ✅ 已完成 (02/07) |
| **3 Part 2** | Upload → Style 綁定（全鏈路 style_id 傳遞）| ✅ 已完成 (02/07) |
| 3 Part 3 | 子頁面麵包屑 + 警告 Banner | ❌ 未開始 |
| 3 Part 4 | Kanban ?style= 自動篩選 | ❌ 未開始 |
| 3 Part 5 | 清理 + 驗證 | ❌ 未開始 |

---

## 02/07 已完成的修改

### Part 1：Style Center 重寫（核心 UI）

**新增 4 個組件：**

| 檔案 | 說明 | 行數 |
|------|------|------|
| `components/styles/StepCard.tsx` | 通用 stepper 卡片（展開/收合 + 狀態 icon + 操作按鈕）| ~107 |
| `components/styles/CreateSampleForm.tsx` | Step ⑤ 內嵌表單（type/qty/priority + 未驗證警告）| ~128 |
| `components/styles/DownloadsSection.tsx` | Step ⑥ 下載按鈕組（MWO/Quote PDF/Excel）| ~138 |
| `components/styles/StyleBreadcrumb.tsx` | 麵包屑導航 `Styles > LW1FLPS > BOM` | ~38 |

**重寫 1 個頁面：**

| 檔案 | 改動 |
|------|------|
| `app/dashboard/styles/[id]/page.tsx` | 從 5-Tab 改為 6-Step Stepper 佈局，內嵌 Sample 建立 + MWO 操作 |

**Stepper 六步：**

```
① Tech Pack — 上傳狀態 + [Upload for this Style]
② Translation — 進度統計 + [Translate All] / [Review →]
③ BOM — 驗證統計 + [Verify All] / [Edit →]
④ Spec — 驗證統計 + [Verify All] / [Edit →]
⑤ Sample & MWO — 建立 Sample / 多輪 Run 列表 / Issue MWO / Download PDF
⑥ Downloads — MWO + Quote PDF/Excel 下載
```

**新增 3 個 hooks（在 `useStyleDetail.ts`）：**

| Hook | 功能 |
|------|------|
| `useCreateSampleWithMWO()` | 兩步建立：createSampleRequest → confirmSampleRequest |
| `useCreateNextRound(requestId)` | 多輪 Fit Sample：createNextRun |
| `useIssueMWO()` | 發行 MWO：transitionSampleRun(runId, 'issue_mwo') |

---

### Part 2：Upload → Style 綁定

**完整 style_id 傳遞鏈：**

```
Upload (?style_id=xxx)     ← 從 Style Center [Upload] 按鈕進入
  ↓ 上傳完成
Processing (?style_id=xxx) ← 自動帶入
  ↓ 分類完成
Review (?style_id=xxx)     ← 自動帶入
  ↓ 點「Extract」
Backend extract API (?style_id=xxx)  ← 傳給後端
  ↓ perform_extraction(doc, target_style_id=xxx)
  ↓ 用現有 Style，不從檔名新建
  ↓ 提取完成
Redirect → /dashboard/styles/{styleId}  ← 自動回到 Style Center
```

**前端修改：**

| 檔案 | 改動 |
|------|------|
| `app/dashboard/upload/page.tsx` | 讀 `?style_id=`，顯示藍色 context banner，傳 styleId 給 SingleUpload |
| `app/dashboard/documents/[id]/processing/page.tsx` | 讀 `?style_id=`，傳遞到 review 頁 URL |
| `app/dashboard/documents/[id]/review/page.tsx` | 讀 `?style_id=`，傳給 extract API，完成後直接導回 Style Center，顯示 banner |

**後端修改：**

| 檔案 | 改動 |
|------|------|
| `apps/parsing/views.py` | extract endpoint 讀 `?style_id=`，async/sync 都傳給 service/task |
| `apps/parsing/services/extraction_service.py` | `perform_extraction(doc, target_style_id=None)`：若有 target_style_id 用現有 Style |
| `apps/parsing/tasks/_main.py` | `extract_document_task` 加 `target_style_id` 參數 |

---

## 02/07 待完成的修改（Part 3-5 計畫）

### Part 3：子頁面麵包屑 + 警告 Banner

每個子頁面加兩個東西：
1. **StyleBreadcrumb** — `Styles > LW1FLPS > BOM`
2. **ReadinessWarningBanner** — 頂部橫幅顯示就緒度 + Style Center 連結（已有組件，部分頁面缺少）

| 檔案 | 現狀 | 待改 |
|------|------|------|
| `revisions/[id]/bom/page.tsx` | ✅ 已有 Banner + Style Center 按鈕 | 加 StyleBreadcrumb |
| `revisions/[id]/spec/page.tsx` | ✅ 已有 Banner + Style Center 按鈕 | 加 StyleBreadcrumb |
| `revisions/[id]/costing-phase23/page.tsx` | ❌ 沒有 Banner | 加 Banner + StyleBreadcrumb |
| `revisions/[id]/review/page.tsx` | ❌ 沒有 Banner | 加 Banner + StyleBreadcrumb |

### Part 4：Kanban 自動篩選

| 檔案 | 改動 |
|------|------|
| `samples/kanban/page.tsx` | 讀 `?style=` query param → 初始化 search state → 自動篩選該款式卡片 |

Style Center 的 "Open in Kanban →" 連結帶：`/dashboard/samples/kanban?style={styleNumber}`

### Part 5：清理 + 驗證

| 項目 | 說明 |
|------|------|
| 刪除 `ReadinessChecklist.tsx` | 被 Stepper 取代 |
| DocumentsTab Upload 連結 | 改為 `/dashboard/upload?style_id={id}` |
| Toast 回饋驗證 | 所有操作（Verify All / Translate All / Create Sample / Issue MWO）都有 toast |
| 完整流程測試 | Journey 1-5 測試（見下方） |

---

## 完整改動清單（已改 + 待改）

### 新增檔案（✅ 已建立）

| 檔案 | 說明 |
|------|------|
| `components/styles/StepCard.tsx` | Stepper 卡片組件 |
| `components/styles/CreateSampleForm.tsx` | Sample 建立表單 |
| `components/styles/DownloadsSection.tsx` | 下載按鈕組 |
| `components/styles/StyleBreadcrumb.tsx` | 麵包屑導航 |

### 已修改檔案（✅ Part 1-2）

| 檔案 | 改動 |
|------|------|
| `styles/[id]/page.tsx` | 重寫：Tabs → Stepper |
| `lib/hooks/useStyleDetail.ts` | +3 hooks (CreateSampleWithMWO / CreateNextRound / IssueMWO) |
| `upload/page.tsx` | 讀 ?style_id，顯示 banner |
| `documents/[id]/processing/page.tsx` | 傳遞 style_id 到 review |
| `documents/[id]/review/page.tsx` | 傳 style_id 給 API，完成後導回 Style Center |
| `parsing/views.py` | extract endpoint 讀 style_id |
| `parsing/services/extraction_service.py` | perform_extraction 加 target_style_id |
| `parsing/tasks/_main.py` | extract_document_task 加 target_style_id |

### 待修改檔案（❌ Part 3-5）

| 檔案 | 改動 |
|------|------|
| `revisions/[id]/bom/page.tsx` | 加 StyleBreadcrumb |
| `revisions/[id]/spec/page.tsx` | 加 StyleBreadcrumb |
| `revisions/[id]/costing-phase23/page.tsx` | 加 Banner + StyleBreadcrumb |
| `revisions/[id]/review/page.tsx` | 加 Banner + StyleBreadcrumb |
| `samples/kanban/page.tsx` | 讀 ?style= 自動 filter |
| `components/styles/ReadinessChecklist.tsx` | 刪除（被 Stepper 取代）|

---

## 驗證方式（Part 3-5 完成後）

### Journey 1：新款式完整流程
1. `/dashboard/styles` → 款式列表
2. 點某款式 → `/dashboard/styles/{id}` → Stepper 顯示
3. Step ① [Upload for this Style] → Upload 頁顯示 banner
4. 上傳 PDF → Processing → Review → Extract（帶 style_id）
5. 自動回到 Style Center → 就緒度更新
6. Step ② [Translate All] → toast → 進度更新
7. Step ③ [Verify All] → toast → ✅
8. Step ⑤ 選 Proto / 2 / Normal → [Create] → MWO 出現
9. Step ⑥ [MWO PDF] → 下載成功

### Journey 2：BOM 編輯後返回
1. Style Center → Step ③ [Edit →] → BOM 頁
2. BOM 頁顯示 Banner + 麵包屑 `Styles > LW1FLPS > BOM`
3. 編輯完 → 點麵包屑 → 回到 Style Center → 就緒度已更新

### Journey 3：Kanban 連結
1. Style Center → Step ⑤ [Open in Kanban →]
2. Kanban 自動 filter 到該款式

### Journey 4：多輪 Fit Sample
1. Style Center → Step ⑤ Run #1 (Issued)
2. [Create Next Round] → Run #2 出現（MWO Draft）
3. [Issue MWO] → [PDF] 下載

---

## 技術備註

- **不改後端資料模型**：純 UX 改動 + query param 傳遞
- **後端唯一新邏輯**：`perform_extraction` 的 `target_style_id` 參數（跳過檔名建 Style）
- **Toast 用 `sonner` 函式庫**（非 shadcn/ui toast）
- **React Query 失效策略**：所有 mutation 完成後 invalidate `style-readiness` + 相關 query key
- **SampleRequest 兩步確認流程**：`createSampleRequest` → `confirmSampleRequest`（生成 Run + MWO + CostSheet）
